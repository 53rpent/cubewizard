<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ analysis_info.title }} - CubeWizard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            align-items: center;
        }
        
        .breadcrumb {
            background: white;
            padding: 1rem 2rem;
            border-bottom: 1px solid #eee;
        }
        
        .breadcrumb a {
            color: #667eea;
            text-decoration: none;
        }
        
        .breadcrumb a:hover {
            text-decoration: underline;
        }
        
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 1rem;
            align-items: center;
        }
        
        .description {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .description h2 {
            color: #667eea;
            margin-bottom: 1rem;
        }
        
        .description p {
            font-size: 1.1rem;
            line-height: 1.7;
            color: #555;
        }
        
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 0.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 600px;
            display: flex;
            flex-direction: column;
        }
        
        #detailed-chart {
            width: 100%;
            flex: 1;
            min-height: 580px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* Ensure Plotly chart is centered */
        #detailed-chart .plotly-graph-div {
            margin: 0 auto !important;
        }
        
        .data-container {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .table th,
        .table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .table th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .table tr:hover {
            background: #f8f9fa;
        }
        
        .positive {
            color: #28a745;
            font-weight: bold;
        }
        
        .negative {
            color: #dc3545;
            font-weight: bold;
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
            color: #666;
            font-size: 1.2rem;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 2rem;
            border-radius: 8px;
            border: 1px solid #f5c6cb;
            margin: 2rem 0;
        }
        
        .back-button {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 0.75rem 1.5rem;
            text-decoration: none;
            border-radius: 4px;
            margin-bottom: 2rem;
            transition: background 0.2s ease;
        }
        
        .back-button:hover {
            background: #764ba2;
        }
        
        .footer {
            background: white;
            border-top: 1px solid #eee;
            padding: 2rem;
            margin-top: 4rem;
            text-align: center;
            color: #666;
        }
        
        .footer p {
            margin-bottom: 0.5rem;
        }
        
        .footer a {
            color: #667eea;
            text-decoration: none;
        }
        
        .footer a:hover {
            text-decoration: underline;
        }
        
        .footer .timestamp {
            font-size: 0.875rem;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>{{ analysis_info.title }}</h1>
        <p>Detailed analysis for {{ cube_id }}</p>
    </div>
    
    <div class="breadcrumb">
        <a href="index.html">‚Üê Back to Dashboard</a>
    </div>
    
    <div class="container">
        <div class="description">
            <h2>Analysis Overview</h2>
            <p>{{ analysis_info.description }}</p>
        </div>
        
        <div id="chart-section" class="chart-container" style="display: none;">
            <div id="detailed-chart"></div>
        </div>
        
        <div id="data-section" class="data-container" style="display: none;">
            <div id="detailed-data"></div>
        </div>
        
        <div id="loading" class="loading">
            Loading detailed analysis...
        </div>
        
        <div id="error" class="error" style="display: none;"></div>
    </div>
    
    <div class="footer">
        <p>Questions? Suggestions? Want to see the raw data? Contact me at <a href="mailto:amatveyenko@outlook.com">amatveyenko@outlook.com</a></p>
        <p class="timestamp">Last updated: <span id="timestamp">{{ timestamp }}</span></p>
    </div>
    
    <script>
        const cubeId = '{{ cube_id }}';
        const analysisType = '{{ analysis_type }}';
        
        // Embedded data from static generation
        const embeddedData = {{ cube_data }};
        
        // Load detailed analysis data
        function loadDetailedAnalysis() {
            try {
                displayDetailedAnalysis(embeddedData);
                loadDetailedChart();
                hideLoading();
            } catch (error) {
                showError('Failed to load analysis data: ' + error.message);
            }
        }
        
        function displayDetailedAnalysis(data) {
            if (analysisType === 'performance') {
                displayPerformanceAnalysis(data.card_performances);
            } else if (analysisType === 'synergies') {
                displaySynergyAnalysis(data.synergies);
            }
            
            document.getElementById('data-section').style.display = 'block';
        }
        
        function displayPerformanceAnalysis(performances) {
            const topPerformers = performances.filter(p => p.performance_delta > 0).slice(0, 25);
            const underperformers = performances.filter(p => p.performance_delta < -0.05 && p.appearances >= 3);
            
            let html = '<h3>Top Performing Cards</h3>';
            html += '<table class="table"><thead><tr><th>Card Name</th><th>Appearances</th><th>Win Rate</th><th>Performance Delta</th><th>Record</th></tr></thead><tbody>';
            
            topPerformers.forEach(card => {
                const delta = card.performance_delta >= 0 ? `+${(card.performance_delta * 100).toFixed(1)}%` : `${(card.performance_delta * 100).toFixed(1)}%`;
                html += `<tr>
                    <td><strong>${card.name}</strong></td>
                    <td>${card.appearances}</td>
                    <td>${(card.win_rate * 100).toFixed(1)}%</td>
                    <td class="${card.performance_delta >= 0 ? 'positive' : 'negative'}">${delta}</td>
                    <td>${card.wins}-${card.losses}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            
            if (underperformers.length > 0) {
                html += '<h3 style="margin-top: 2rem;">Underperforming Cards</h3>';
                html += '<table class="table"><thead><tr><th>Card Name</th><th>Appearances</th><th>Win Rate</th><th>Performance Delta</th><th>Record</th></tr></thead><tbody>';
                
                underperformers.forEach(card => {
                    const delta = `${(card.performance_delta * 100).toFixed(1)}%`;
                    html += `<tr>
                        <td><strong>${card.name}</strong></td>
                        <td>${card.appearances}</td>
                        <td>${(card.win_rate * 100).toFixed(1)}%</td>
                        <td class="negative">${delta}</td>
                        <td>${card.wins}-${card.losses}</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
            }
            
            document.getElementById('detailed-data').innerHTML = html;
        }
        
        function displaySynergyAnalysis(synergies) {
            let html = '<h3>Card Synergies</h3>';
            html += '<table class="table"><thead><tr><th>Card 1</th><th>Card 2</th><th>Together Win Rate</th><th>Synergy Bonus</th><th>Together Record</th></tr></thead><tbody>';
            
            synergies.forEach(synergy => {
                const bonus = synergy.synergy_bonus >= 0 ? `+${(synergy.synergy_bonus * 100).toFixed(1)}%` : `${(synergy.synergy_bonus * 100).toFixed(1)}%`;
                html += `<tr>
                    <td><strong>${synergy.card1}</strong></td>
                    <td><strong>${synergy.card2}</strong></td>
                    <td>${(synergy.together_win_rate * 100).toFixed(1)}%</td>
                    <td class="${synergy.synergy_bonus >= 0 ? 'positive' : 'negative'}">${bonus}</td>
                    <td>${synergy.together_wins}-${synergy.together_losses}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            document.getElementById('detailed-data').innerHTML = html;
        }
        
        function loadDetailedChart() {
            const chartType = getChartType(analysisType);
            if (!chartType) return;
            
            try {
                // Use embedded chart data
                const chartData = JSON.parse(embeddedData.charts[chartType]);
                
                // Make the chart fill the container better and center it
                const containerWidth = document.getElementById('detailed-chart').clientWidth;
                chartData.layout.width = containerWidth;
                chartData.layout.height = 560;
                chartData.layout.margin = { l: 60, r: 60, t: 40, b: 60 };
                chartData.layout.autosize = false;  // Disable autosize to use explicit width
                
                // Center the plot area
                chartData.layout.xaxis = chartData.layout.xaxis || {};
                chartData.layout.yaxis = chartData.layout.yaxis || {};
                chartData.layout.xaxis.automargin = true;
                chartData.layout.yaxis.automargin = true;
                
                Plotly.newPlot('detailed-chart', chartData.data, chartData.layout, {
                    responsive: false,  // Disable responsive to prevent auto-resizing
                    displayModeBar: true,
                    useResizeHandler: false
                }).then(function() {
                    // Ensure chart is centered after rendering
                    const plotDiv = document.getElementById('detailed-chart');
                    const plotlyDiv = plotDiv.querySelector('.plotly-graph-div');
                    if (plotlyDiv) {
                        plotlyDiv.style.margin = '0 auto';
                        plotlyDiv.style.display = 'block';
                    }
                    
                    // Add resize handler to maintain proper width
                    window.addEventListener('resize', function() {
                        const newWidth = document.getElementById('detailed-chart').clientWidth;
                        Plotly.relayout('detailed-chart', {
                            width: newWidth
                        });
                    });
                });
                
                document.getElementById('chart-section').style.display = 'block';
            } catch (error) {
                console.error('Failed to load chart:', error);
            }
        }
        
        function getChartType(analysisType) {
            const mapping = {
                'performance': 'performance_scatter',
                'color': 'detailed_color_performance',
                'synergies': 'performance_scatter'
            };
            return mapping[analysisType];
        }
        
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        
        function showError(message) {
            document.getElementById('error').innerHTML = message;
            document.getElementById('error').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }
        
        function goBackToDashboard() {
            // Go back to dashboard
            window.location.href = 'index.html';
        }
        
        // Load the analysis when page loads
        document.addEventListener('DOMContentLoaded', loadDetailedAnalysis);
    </script>
</body>
</html>